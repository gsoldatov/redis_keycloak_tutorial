+ KeyCloak container:
    + pass params from configuration;
    + setup programmatically:
        ++ add & delete app realm;
        ++ add & delete client;
        ++ add & delete roles;
        ++ add & delete users;
    + ensure realm & user configuration persists container being stopped;
    x add healthcheck to docker run command to check if container is up;
    + expose healthcheck port;

+ CLI utility for containers:
    + run:
        + runs Keycloak container;
        + performs initial configuration of keycloak;
    + stop:
        + stops Keycloak container;
    + remove:
        + removes Keycloak container;

+ web app:
    + auth routes:
        + login:
            + gets a new token from Keycloak & returns it;
            + handles network errors;
            + handles incorrect credentials;
        + logout;
    + app routes:
        + protected (first role);
        + protected (second role);

+ tests:
    + fixtures:
        + config;
        + KC container;
        + wait for Keycloak to be ready;
        + test config (custom KC realm);
        + test KC realm & data (drop in teardown);
        + async test client (app without cache);
        + async test client (app without cache & with "disabled" keycloak); # or override dependency KC service dependency
    
    + tests:
        + login:
            + validation;
            + network error;
            + disabled user;
            + invalid credentials;
            + successful login;
        + logout:
            + network error;
            + missing token;
            + invalid token:
                + wrong format;
                x add a role, which does not exist;
            + expired token;
            x token of a disabled user;
            + successful logout;
        + first protected route:
            + network error when validating token;
            + missing token;
            + invalid token format;
            + expired token;
            + token without required role;
            + valid request with a correct token;
            + valid request with a refreshed token;
        + second protected route:
            + network error when validating token;
            + missing token;
            + invalid token format;
            + expired token;
            + token without required role;
            + valid request with a correct token;
            + valid request with a refreshed token;

x limit scope to app_client when logging in;

+ Keycloak:
    + change app roles:
        x add `can_login` or use default role/setting;
        + add `can_post`;

+ setup Redis container:
    + add configuration;
    + add container manager;
    + add to CLI;

- Redis-using routes, tests & misc:
    + change routes:
        + add /auth prefix to auth routes;
        + add /misc prefix to test routes;
    
    // redis.io/docs/latest/develop/clients/patterns/twitter-clone/

    + /auth/register route:
        + validates provided credentials;
        + passes provided credentials to Keycloak;
        + returns 503, if Keycloak is unavailable;
        + returns 400, if user was not created;
        + adds data of the new user to the database;
        + returns 503, if Redis is unavailable;
        + returns 201;
    
    + test fixtures:
        x add key prefix for all Redis keys to support running tests;
        
        + rename fixtures;

        + config fixture for unavailable Keycloak & Redis:
            + add Redis settings;
            + change scope to module;
        
        + add a shared test state manager class;    // use a file lock https://py-filelock.readthedocs.io/en/latest/index.html
        + add a session fixute for resetting the shared state;

        + add a fixture for obtaining a Redis database number:
            + use a file lock to read currently used database number, increment it and write new state;
            x store an array of released database numbers:
                x append to it when module tests are done;
                x pop from it before incrementing the counter;
                x do not exceed maximum database number from the config;
                x retry, if counter reached max value and no released number are available;

        + test config fixture:
            + module-scoped;
            + set test Redis settings (db number & network);
        
        + Redis client fixture:
            + module-scoped;
            + ensures Redis is up;
            + connects to the correct DB;
        
        + app & client fixtures with Keycloak & Redis available:
            + add Redis DB cleanup after tests;
        
        + config fixture for Redis unavailable:
            + module-scoped;
            + ensures Keycloak is available;
        
        + app & client fixtures for Redis unavailable;
        
    + /auth/register tests:
        + validation;
        + keycloak network error;
        + redis network error;
        + existing email;
        + existing username;
        + successful registration;
    
    + rename KeycloakManager & keycloak_manager + keycloak/setup.py;

    + add error middleware:
        + catch existing exceptions:
            + split AuthException into exceptions, which result in 400 & 401 responses;
        + catch other exceptions:
            + log;
            + return 500;
    
    x proparage subprocess errors during container operations;      // requires running individual healthchecks for each container
    
    // returns user info
    + GET /users/:username route:
        + returns public user info from the database;
        + returns 404 if user not found;
    
    + GET /users/:username tests:
        + username validation;
        + Redis network error => 503;
        + username validation is executed;
        + non-existing user => 404;
        + existing user => 200 + correct user data;
    
    + refactor validation tests:
        + run all validation tests against Pydantic models + run a single route test for check if validation works;
    
    // adds a user follower
    - PUT /users/:username/followers/:follower_id:
        - validates user token:
            - returns 401, if token does not exist;
            - retuns 403, if token was issued for another user;
        - adds `follower_id` to the followers sorted set of `username`;
        - adds posts of `username` to the feed of `follower_id`;
        - returns 404 if `username` or `follower_id` does not exist;
    
    // removes a user follower
    - DELETE /users/:username/followers/:follower_id:
        - validates user token:
            - returns 401, if token does not exist;
            - retuns 403, if token was issued for another user;
        - removes `follower_id` from the followers sorted set of `username`;
        - removes posts of `username` from the feed of `follower_id`;
        - returns 404 if `username` does not exist;
        - retunrs 200 if `follower_id` does not exist;
    
    // returns paginated user followers
    - GET /users/:username/followers:
        - gets starting post from URL params;
        - returns 404 if `username` does not exist;
        - returns a paginated list of followers of `username`;
        - returns pagination info (total followers, next & prev pages);
    
    // adds a new post of a user
    - POST /users/:username/posts:
        - validates user token:
            - returns 401, if token does not exist;
            - retuns 403, if token was issued for another user;
        - validates user post body;
        - adds the post to the list of user posts;
        - adds the post to the feeds of user's followers;
    
    // returns paginated posts of user
    - GET /users/:username/posts:
        - gets starting post from URL params;
        - returns 404 if $username does not exist;
        - returns a paginated list of user's posts;
        - returns pagination info (next post ID & total posts);
    
    // returns paginated feed of user
    - GET /users/:username/feed:
        - gets a starting post from URL params;
        - returns 404 if $username does not exist;
        - returns a paginated list of posts in user's feed;
        - returns pagination info (next post ID & total posts);

- Redis keys & values:
    - user:$username: hash with data of $username;
    - user_followers:$username: sorted set with IDs of followers of $username;
    - user_feed:$username: sorted set with post IDs of users, followed by $username;
    - user_posts:$username: list of post IDs of $username posts;
    - id_next_post: ID of next created post;
    - post:$post_id: data of $post_id;

? move access/refresh tokens store to Redis;

- allow logging in only via email (forbid using username) & add tests;

- tests:
    ???

- Redis cache:
    - add tokens on login;
    - invalidate tokens on logout or expiry;
    - refresh tokens on valid route calls;

- CLI utility for contains:
    - add Redis container management;

- tests:
    - mocks:
        - test config;
        - test containers:
            ? use dev containers with temp databases & realms;
        - app & client;
    
    - tests:
        ???
